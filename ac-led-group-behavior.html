<link rel="import" href="/bower_components/polymer/polymer.html">
<script src='./LinkedList.js'></script>
<script>
    /**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    acLedGroupBehavior = {
        listeners:{
            'view-audio-load':'_onLoadViewAudio'
        },
        properties: {
        /* ------------------- Loading ------------------- */
            name: {
                type: String
            },
            totalViewAudios: {
                type: Number,
                value: 0
            },
            loadedViewAudios: {
                type: Number,
                value: 0
            },
            finishedLoading: {
                type: Boolean,
                value: false
            },
        /* ------------------- Setup ------------------- */
            flags:{
                type:Array,
                value:[]
            },
            acLedStates:{
                type:Number,
                value:2
            },
            index: {
                type: Number
            },
            rotation: {
                type: Boolean,
                value: false
            },
            instrumentPanning: {
                type: Number,
                value: 0,
                observer: '_setSynthInstrumentPanning'
            },
            playbackPanning: {
                type: Number,
                value: 0,
                observer: '_setSynthPlaybackPanning'
            },
            instrumentVolume: {
                type: Number,
                value: 1,
                observer: '_setSynthInstrumentVolume'
            },
            playbackVolume: {
                type: Number,
                value: 1,
                observer: '_setSynthPlaybackVolume'
            },
            pitch:{
                type:Number,
                value:67
            },
        /* ------------------- Defaults ------------------- */
            defaultInstrumentPanning: {
                type: Number,
                value: 0
            },
            defaultPlaybackPanning: {
                type: Number,
                value: 0
            },
            defaultInstrumentVolume: {
                type: Number,
                value: 1
            },
            defaultPlaybackVolume: {
                type: Number,
                value: 1
            },
        /* ------------------- Action ------------------- */
            playbackAcLedActions: {
                type: Object
            },
            instrumentAcLedActions: {
                type: Object
            },
            MIDIEventToNoteMap:{
                type:Array,
                value:[]
            }
        },
    /* ----------------  Audio ------------------------- */
        setViewAudioUrl: function (viewAudioIndex, audioUrl) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            nodeList[viewAudioIndex].setAudioUrl(audioUrl);
        },
        loadNotes: function (pitch) {
            this.loadedViewAudios = 0;
            this.finishedLoading = false;

        /* ------------------- Pitch ------------------- */
            var diff = pitch - this.pitch ;
            this.pitch += diff ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var j = 0; j < nodeList.length; j++) {
                var channel = nodeList[j].channel ;
                for (var i = 0; i < this.MIDIEventToNoteMap[channel].length; i++) {
                    if( this.MIDIEventToNoteMap[channel][i] === null || this.MIDIEventToNoteMap[channel][i] === undefined )
                        continue ;
                    this.MIDIEventToNoteMap[channel][i] = this._addPitch(this.MIDIEventToNoteMap[channel][i],channel,diff);
                }
            }
        /* ------------------- Audio loading ------------------- */
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var j = 0; j < nodeList.length; j++) {
                var channel = nodeList[j].channel ;
                for (var i = 0; i < this.MIDIEventToNoteMap[channel].length; i++) {
                    if (this.MIDIEventToNoteMap[channel][i] === undefined || this.MIDIEventToNoteMap[channel][i] === null)
                        continue ;
                    nodeList[j].loadNote(this.MIDIEventToNoteMap[channel][i]);
                }
            }
        },
    /* ------------------- MIDIEvents ------------------- */
        onMIDIEvent: function (e) {
            if(e.noGUI === null || e.noGUI === undefined)
                this._MIDIEventToGUI(e) ;
            if(e.noAudio === null || e.noAudio === undefined)
                this._MIDIEventToAudio(e) ;
        },
        _MIDIEventToGUI: function(e){
            e.acLedId = this._mapMIDIEventToAcLedId(e.midiNote, e.channel);
            if(e.cmd === 'note-on')
                e.acLedState = this._mapMIDIEventToAcLedState(e.midiNote, e.channel);
            else {
                e.acLedState = 0 ;
            }
            if (e.origin === 'playback' || e.origin === 'playbackGUI') {
                if (e.playNow !== undefined) {
                    e.when = context.currentTime;
                } else {
                    e.when = context.currentTime + (e.tempo) * (e.time - e.playbackTime);
                }
                this.playbackAcLedActions.push(e);
            }
            if (e.origin === 'instrument') {
                this.instrumentAcLedActions.push(e);
            }
        },
        _MIDIEventToAudio: function(e){
            if (e.cmd === 'note-on')
                this.$$('VIEW-AUDIO[channel' + e.channel + ']')._startAudio(this.MIDIEventToNoteMap[e.channel][e.midiNote],e);
            else {
                this.$$('VIEW-AUDIO[channel' + e.channel + ']')._stopAudio(e);
            }
        },
        _mapMIDIEventToNote: function(channel,midiNote,newNote){
            if (!this.flags[channel]) {
                this.flags[channel]=true ;
                this.MIDIEventToNoteMap[channel] = [] ;
            }
            this.MIDIEventToNoteMap[channel][midiNote] = newNote;
        },
    /* ------------------- MIDIEvents Default helpers  ------------------- */
        _mapMIDIEventToAcLedId: function(midiNote,channel){
            return midiNote ;
        },
        _mapMIDIEventToAcLedState: function(cmd,midiNote,channel){
            if (cmd === 'note-on')
                return 1 ;
            return 0 ;
        },
        _addPitch: function (note,channel,diff) {
            return note+diff ;
        },
    /* ------------------- Chords ------------------- */
        displayChord: function (chord) {
            if (this._displayChord !== null && this._displayChord !== undefined) {
                this._displayChord(chord);
            }
        },
    /* -------------------- GUI ------------------------- */

        updateGUI: function () {
            if (this.playbackAcLedActions.length > 0) {
                if (this.playbackAcLedActions.first.value.when < context.currentTime) {
                    this.$$('[channel' + this.playbackAcLedActions.first.value.channel + '][id' + this.playbackAcLedActions.first.value.acLedId + ']').render(this.playbackAcLedActions.first.value.origin, this.playbackAcLedActions.first.value.acLedState);
                    this.playbackAcLedActions.popFirst();
                }
            }
            if (this.instrumentAcLedActions.length > 0) {
                this.$$('[channel' + this.instrumentAcLedActions.first.value.channel + '][id' + this.instrumentAcLedActions.first.value.acLedId + ']').render(this.instrumentAcLedActions.first.value.origin, this.instrumentAcLedActions.first.value.acLedState);
                this.instrumentAcLedActions.popFirst();
            }
        },
        toggleNotes: function (target, value) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                if (target === 'playback') {
                    nodeList[i].showingPlaybackNotes = value;
                } else {
                    nodeList[i].showingInstrumentNotes = value;
                }
            }
        },
        setOpacity: function (acLedId, opacity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                if (acLedId === 'playback')
                    nodeList[i].playbackOpacity = opacity;
                if (acLedId === 'instrument')
                    nodeList[i].instrumentOpacity = opacity;
                }
            },
        resetGUI: function (origin, clearState) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].resetGUI(origin, clearState);
            }
            while (this.playbackAcLedActions.length > 0) {
                var when;
                if (this.playbackAcLedActions.first.value.playNow !== undefined) {
                    when = context.currentTime;
                } else {
                    when = context.currentTime + (this.playbackAcLedActions.first.value.tempo) * (this.playbackAcLedActions.first.value.time - this.playbackAcLedActions.first.value.playbackTime);
                }
                if (when < context.currentTime || this.playbackAcLedActions.first.value.playNow !== undefined) {
                    this.$$('[channel' + this.playbackAcLedActions.first.value.channel + '][id' + this.playbackAcLedActions.first.value.acLedId + ']').render(this.playbackAcLedActions.first.value.origin, this.playbackAcLedActions.first.value.acLedState);
                    this.playbackAcLedActions.popFirst();
                } else {
                    break;
                }
            }
            this.playbackAcLedActions.clear();
            this.instrumentAcLedActions.clear();
        },
    /* ----------------- View audio -------------------------- */
        stopAudio: function (origin) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            var i;
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].stop(origin);
            }
        },
        setVelocity: function (velocity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity);
            }
        },
        _setSynthInstrumentPanning: function (panning) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            if (nodeList[0].totalNotes === undefined)
                return;
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setInstrumentPanning(panning);
            }
        },
        _setSynthPlaybackPanning: function (panning) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            if (nodeList[0].totalNotes === undefined)
                return;
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setPlaybackPanning(panning);
            }
        },
        _setSynthPlaybackVolume: function (volume) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            if (nodeList[0].totalNotes === undefined)
                return;
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setPlaybackGain(volume);
            }
        },
        _setSynthInstrumentVolume: function (volume) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            if (nodeList[0].totalNotes === undefined)
                return;
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setInstrumentGain(volume);
            }
        },
    /* ------------------- acView Communication ------------------- */
        _acViewCallFunction: function (functionName, args) {
            if (parent !== window) {
                parent.postMessage([
                    functionName, args
                ], '*');
            } else {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.fire('ac-view-call', {
                        functionName: functionName,
                        args: args
                    });
                });
            }
        },
    /* -------------- Loading -------------------- */
        _onLoadViewAudio: function () {
            this.loadedViewAudios++;
            if (this.loadedViewAudios === this.totalViewAudios) {
                this.fire('instrument-acLeds-loaded-2');
            }
        },
        registerAcLedGroup: function () {
            this._acViewCallFunction('registerAcLedGroup', {
                name: this.name,
                defaultPlaybackVolume: this.defaultPlaybackVolume * 100,
                defaultInstrumentVolume: this.defaultInstrumentVolume * 100,
                defaultInstrumentPanning: this.defaultInstrumentPanning * 100,
                defaultPlaybackPanning: this.defaultPlaybackPanning * 100
            });
        },
        registerViewAudios: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                this._acViewCallFunction('registerViewAudio', {
                    name: nodeList[i].id,
                    url: nodeList[i].audioUrl,
                    acLedsGroupIndex: this.index,
                    viewAudioIndex: i
                });
            }
        },
    /* ------------------- Setup ------------------- */
        initAcLeds: function(e){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].init(e);
            }
        },
        updateAcLedStyles: function(e){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].updateAcLedStyles(e);
            }
        },
        getDefaultAudioUrls: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            var defaultAudioUrls = [];
            for (var i = 0; i < nodeList.length; i++) {
                if (nodeList[i].defaultAudioUrl !== null && nodeList[i].defaultAudioUrl !== undefined)
                    defaultAudioUrls.push(nodeList[i].defaultAudioUrl);
                }
            return defaultAudioUrls;
        },
        setIndex: function (index) {
            this.index = index;
        },
        onFinishedLoadingNotes: function () {},
        ready: function () {
            this.MIDIEventToNoteMap = [] ;
            this.flags = []  ;
            this.playbackAcLedActions = new LinkedList();
            this.instrumentAcLedActions = new LinkedList();
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            this.totalViewAudios = nodeList.length ;

            for (var i = 0; i < nodeList.length; i++) {
                var channel = nodeList[i].channel ;
                this.flags[channel] = false ;
                this.MIDIEventToNoteMap[channel] =  [] ;
                nodeList[i].setAttribute("channel"+channel, "");
                var acLeds = Polymer.dom(this.root).querySelectorAll('[channel'+channel+'][acLed]');
                for (var j = 0; j < acLeds.length; j++) {
                    var acId = acLeds[j].acId
                    acLeds[j].setAttribute("id"+acId, "");
                    this.MIDIEventToNoteMap[channel][acId] = acId ;
                }
            }
            this._acViewCallFunction('addTotalViewAudios', this.totalViewAudios);
            this.loadedViewAudios = 0;
            setInterval(this.updateGUI.bind(this), 5);
        }
    };
</script>
