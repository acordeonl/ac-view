
<link rel="import" href="/bower_components/polymer/polymer.html">
<script src='./LinkedList.js'></script>
<script>
    /**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    acLedGroupBehavior = {
        listeners:{
            'view-audio-load':'___acV_onLoadViewAudio'
        },
        properties: {
        /* ------------------- Loading ------------------- */
            name: {
                type: String
            },
            ___acV_totalViewAudios: {
                type: Number,
                value: 0
            },
            ___acV_loadedViewAudios: {
                type: Number,
                value: 0
            },
        /* ------------------- Setup ------------------- */
            ___acV_flags:{
                type:Array,
                value:[]
            },
            ___acV_index: {
                type: Number
            },
            ___acV_rotation: {
                type: Boolean,
                value: false
            },
            ___acV_instrumentPanning: {
                type: Number,
                value: 0,
                observer: '___acV_setSynthInstrumentPanning'
            },
            ___acV_playbackPanning: {
                type: Number,
                value: 0,
                observer: '___acV_setSynthPlaybackPanning'
            },
            ___acV_instrumentVolume: {
                type: Number,
                value: 1,
                observer: '___acV_setSynthInstrumentVolume'
            },
            ___acV_playbackVolume: {
                type: Number,
                value: 1,
                observer: '___acV_setSynthPlaybackVolume'
            },
            ___acV_pitch:{
                type:Number
            },
            ___acV_referencePitch:{
                type:Number
            },
        /* ------------------- Defaults ------------------- */
            defaultInstrumentPanning: {
                type: Number,
                value: 0
            },
            defaultPlaybackPanning: {
                type: Number,
                value: 0
            },
            defaultInstrumentVolume: {
                type: Number,
                value: 1
            },
            defaultPlaybackVolume: {
                type: Number,
                value: 1
            },
        /* ------------------- Action ------------------- */
            ___acV_instruments:{
                type:Array
            },
            ___acV_MIDIEventToNoteMap:{
                type:Array,
                value:[]
            },
            ___acV_mapKeyboardToNote:{
                type:Array,
                value:[]
            }
        },
    /* ----------------  Audio ------------------------- */
        ___acVaddPitch: function (diff) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var j = 0; j < nodeList.length; j++) {
                var channel = nodeList[j].channel ;
                for (var i = 0; i < this.___acV_MIDIEventToNoteMap[channel].length; i++) {
                    if( this.___acV_MIDIEventToNoteMap[channel][i] === null || this.___acV_MIDIEventToNoteMap[channel][i] === undefined )
                        continue ;
                    this.___acV_MIDIEventToNoteMap[channel][i] = this.___acV_handleAddPitch(this.___acV_MIDIEventToNoteMap[channel][i],channel,diff);
                }
            }
            this.___acV_onAddPitch() ;
        },
        ___acV_onAddPitch: function(){

        },
    /* ------------------- Keyboard ------------------- */
        ___acV_setKeyboardToNote: function(key,arg){
            this.___acV_mapKeyboardToNote[key] = arg ;
        },
        ___acV_onKeyboardNoteOn: function(key){
            if (this.___acV_mapKeyboardToNote[key] !== undefined) {
                var e = {};
                e.playNow = 1;
                e.midiNote = this.___acV_mapKeyboardToNote[key][1];
                e.channel = this.___acV_mapKeyboardToNote[key][0];
                e.origin = 'keyboard';
                e.cmd = 'note-on';
                this.___acV_onMIDIEvent(e) ;
            }
        },
        ___acV_onKeyboardNoteOff: function(key){
            if (this.___acV_mapKeyboardToNote[key] !== undefined) {
                var e = {};
                e.playNow = 1;
                e.midiNote = this.___acV_mapKeyboardToNote[key][1];
                e.channel = this.___acV_mapKeyboardToNote[key][0];
                e.origin = 'keyboard';
                e.cmd = 'note-off';
                this.___acV_onMIDIEvent(e) ;
            }
        },
    /* ------------------- Instrument ------------------- */
        ___acVinitInstrumentVolume: function(){
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].initInstrumentVolume() ;
            }
        },
    /* ------------------- MIDIEvents ------------------- */
        ___acV_midiEventToAudioNote: function(channel,midiNote,origin){
            return this.___acV_midiEventToAudioNoteDefault(channel,midiNote,origin) ; 
        },
        ___acV_midiEventToAudioNoteDefault: function (channel,midiNote,origin) {
            var note ;
            if (this.___acV_MIDIEventToNoteMap[channel] !== undefined && this.___acV_MIDIEventToNoteMap[channel] !== null) {
                if (this.___acV_MIDIEventToNoteMap[channel][midiNote] !== undefined && this.___acV_MIDIEventToNoteMap[channel][midiNote] !== undefined)
                    note = this.___acV_MIDIEventToNoteMap[channel][midiNote] ;
                else
                    note = midiNote  ;
            }
            else {
                note = midiNote ;
            }
            return note ;
        },
        ___acV_onMIDIEvent: function (e) {
            if (e.origin !== 'conversion') {
                if(e.noGUI === null || e.noGUI === undefined)
                    this.___acV_MIDIEventToGUI(e) ;
                if(e.noAudio === null || e.noAudio === undefined)
                    this.___acV_MIDIEventToAudio(e) ;
            }
            else{
                this.fire('note-conversion',{eventId:e.id,mapedNote:this.___acV_midiEventToAudioNote(e.channel,e.midiNote,e.origin)}) ;
            }
        },
        ___acV_MIDIEventToGUI: function(e){
            var note = this.___acV_midiEventToAudioNote(e.channel,e.midiNote,e.origin) ;
            e.acLedId = this.___acV_mapMIDIEventToAcLedId(e.channel,e.midiNote,e.origin);
            if (this.$$('[channel' + e.channel + '][id' + e.acLedId + ']') === null || this.$$('[channel' + e.channel + '][id' + e.acLedId + ']') === undefined) {
                this.fire('toast',{msg:'La grabación seleccionada o la configuración del instrumento MIDI conectado no es compatible con la visualización seleccionada'})  ;
                return ;
            }
            e.note = note ;
            if(e.cmd === 'note-on')
                e.acLedState = this.___acV_mapMIDIEventToAcLedState(e.channel,e.midiNote);
            else {
                e.acLedState = 0 ;
            }
            if (e.origin === 'playback') {
                if (e.playNow !== undefined) {
                    e.when = playbackContext.currentTime;
                } else {
                    e.when = playbackContext.currentTime + (e.tempo) * (e.time - e.playbackTime);
                }
                this.playbackAcLedActions.push(e);
            }
            else {
                this[e.origin+'AcLedActions'].push(e) ;
            }
        },
        ___acV_MIDIEventToAudio: function(e){
            var note = this.___acV_midiEventToAudioNote(e.channel,e.midiNote,e.origin) ;
            if (this.$$('VIEW-AUDIO[channel' + e.channel + ']') === undefined) {
                this.fire('toast',{msg:'La visualización seleccionada no soporta el canal '+e.channel})  ;
                return ;
            }
            if (e.cmd === 'note-on' && this.$$('VIEW-AUDIO[channel' + e.channel + ']').notesBuffers[note] !== undefined )
                this.$$('VIEW-AUDIO[channel' + e.channel + ']')._startAudio(note,e);
            else if (e.cmd ==='note-off' && this.$$('VIEW-AUDIO[channel' + e.channel + ']').notesBuffers[note] !== undefined){
                this.$$('VIEW-AUDIO[channel' + e.channel + ']')._stopAudio(e);
            }
            if (this.$$('VIEW-AUDIO[channel' + e.channel + ']').notesBuffers[note] === undefined )
                this.fire('toast',{msg:'Algunas notas no pueden ser reproducidas debido a que no se encuentran en el audio de la visualización'}) ; 
        },
        ___acV_mapMIDIEventToNote: function(channel,midiNote,newNote){
            if (!this.___acV_flags[channel]) {
                this.___acV_flags[channel]=true ;
                this.___acV_MIDIEventToNoteMap[channel] = [] ;
            }
            this.___acV_MIDIEventToNoteMap[channel][midiNote] = newNote;
        },
    /* ------------------- MIDIEvents Default helpers  ------------------- */
        ___acV_mapMIDIEventToAcLedId: function(channel,midiNote,origin){
            return midiNote ;
        },
        ___acV_mapMIDIEventToAcLedState: function(channel,midiNote){
            return 1 ;
        },
        ___acV_handleAddPitch: function (note,channel,diff) {
            return note+diff ;
        },
    /* ------------------- Chords ------------------- */
        // arr: channel, midinote1 ,midinote 2 ...
        ___acV_setChord: function(midiNote,description,arr){
            if (this.chords === undefined)
                this.chords = [] ;
            if (this.chords[midiNote] === undefined)
                this.chords[midiNote] = [] ;
            this.chords[midiNote][description] = arr ;
        },
        ___acVtoggleChords: function(playingChords){
            this.playingChords = playingChords ;
            if (this.playingChords) {
                this.___acV_playCurrentChord() ;
            }
            else {
                this.___acV_stopCurrentChord() ;
            }
        },
        ___acVsetCurrentChord: function (midiNote,description) {
            if (this.chords === undefined)
                return ;
            if (this.playingChords) {
                this.___acV_stopCurrentChord() ;
                if (this.chords[midiNote] !== undefined)
                    this.currentChord = this.chords[midiNote][description] ;
                else
                    this.currentChord = undefined ;
                this.___acV_playCurrentChord() ;
            }
            else {
                if (this.chords[midiNote] !== undefined)
                    this.currentChord = this.chords[midiNote][description] ;
                else
                    this.currentChord = undefined ;
            }
        },
        ___acV_playCurrentChord: function(){
            if (this.currentChord === undefined)
                return ;
            for (let i = 0; i < this.currentChord.length; i++) {
                for (let j = 1; j < this.currentChord[i].length; j++) {
                    var e = {};
                    e.playNow = 1;
                    e.midiNote = this.currentChord[i][j];
                    e.channel = this.currentChord[i][0];
                    e.origin = 'chord';
                    e.cmd = 'note-on';
                    this.___acV_onMIDIEvent(e) ;
                }
            }
        },
        ___acV_stopCurrentChord: function(){
            if (this.currentChord === undefined)
                return ;
            for (let i = 0; i < this.currentChord.length; i++) {
                for (let j = 1; j < this.currentChord[i].length; j++) {
                    var e = {};
                    e.playNow = 1;
                    e.midiNote = this.currentChord[i][j];
                    e.channel = this.currentChord[i][0];
                    e.origin = 'chord';
                    e.cmd = 'note-off';
                    this.___acV_onMIDIEvent(e) ;
                }
            }
        },
    /* -------------------- GUI ------------------------- */
        ___acV_updateGUI: function () {
            if (this.playbackAcLedActions !== null && this.playbackAcLedActions !== undefined && this.playbackAcLedActions.length > 0) {
                if (this.playbackAcLedActions.first.value.when < playbackContext.currentTime) {
                    this.$$('[channel' + this.playbackAcLedActions.first.value.channel + '][id' + this.playbackAcLedActions.first.value.acLedId + ']').___acVrender(this.playbackAcLedActions.first.value.origin, this.playbackAcLedActions.first.value.acLedState,this.playbackAcLedActions.first.value.note);
                    this.playbackAcLedActions.popFirst();
                }
            }
            for (var i = 0; i < this.___acV_instruments.length; i++) {
                var origin = this.___acV_instruments[i] ;
                if (this[origin+'AcLedActions'].length > 0) {
                    this.$$('[channel' + this[origin+'AcLedActions'].first.value.channel + '][id' + this[origin+'AcLedActions'].first.value.acLedId + ']').___acVrender(this[origin+'AcLedActions'].first.value.origin, this[origin+'AcLedActions'].first.value.acLedState,this[origin+'AcLedActions'].first.value.note);
                    this[origin+'AcLedActions'].popFirst();
                }
            }
        },
        ___acVtoggleNotes: function (origin, value) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVtoggleNotes(origin,value) ;
            }
        },
        ___acVsetOpacity: function (origin, opacity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVsetOpacity(origin,opacity) ;
            }
        },
        ___acVclearActions: function(origin){
            while (this.playbackAcLedActions.length > 0) {
                var when;
                if (this.playbackAcLedActions.first.value.playNow !== undefined) {
                    when = playbackContext.currentTime;
                } else {
                    when = playbackContext.currentTime + (this.playbackAcLedActions.first.value.tempo) * (this.playbackAcLedActions.first.value.time - this.playbackAcLedActions.first.value.playbackTime);
                }
                if (when < playbackContext.currentTime || this.playbackAcLedActions.first.value.playNow !== undefined) {
                    this.$$('[channel' + this.playbackAcLedActions.first.value.channel + '][id' + this.playbackAcLedActions.first.value.acLedId + ']').___acVrender(this.playbackAcLedActions.first.value.origin, this.playbackAcLedActions.first.value.acLedState);
                    this.playbackAcLedActions.popFirst();
                } else {
                    break;
                }
            }
            this.playbackAcLedActions.clear();
            // this.instrumentAcLedActions.clear();
        },
        ___acVclearGUI: function (origin) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVclearGUI(origin);
            }
        },
    /* ----------------- View audio -------------------------- */
        ___acVinitPlaybackAudio: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].initPlaybackAudio();
            }
        },
        ___acVsetVelocity: function (velocity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity);
            }
        },
        ___acV_setSynthInstrumentPanning: function (panning) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setInstrumentPanning(panning);
            }
        },
        ___acV_setSynthPlaybackPanning: function (panning) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setPlaybackPanning(panning);
            }
        },
        ___acV_setSynthPlaybackVolume: function (volume) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setPlaybackGain(volume);
            }
        },
        ___acV_setSynthInstrumentVolume: function (volume) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setInstrumentGain(volume);
            }
        },
    /* -------------- Loading -------------------- */
        ___acVloadAudio: function (viewAudioIndex, audioUrl) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            if (nodeList[viewAudioIndex].audioUrl !== audioUrl)
                nodeList[viewAudioIndex].loadAudio(audioUrl);
            else
                this.___acV_onLoadViewAudio() ;
        },
        ___acV_onLoadViewAudio: function () {
            this.___acV_loadedViewAudios++;
            if (this.___acV_loadedViewAudios === this.___acV_totalViewAudios) {
                this.fire('acLedGroup-loaded');
                this.___acV_loadedViewAudios = 0 ;
            }
        },
        ___acVgetAcLedGroup: function () {
            return {
                name: this.name,
                defaultPlaybackVolume: this.defaultPlaybackVolume * 100,
                defaultInstrumentVolume: this.defaultInstrumentVolume * 100,
                defaultInstrumentPanning: this.defaultInstrumentPanning * 100,
                defaultPlaybackPanning: this.defaultPlaybackPanning * 100
            } ;
        },
        ___acVgetViewAudios: function () {
            var viewAudios = [] ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var i = 0; i < nodeList.length; i++) {
                viewAudios.push ( {
                    name: nodeList[i].id,
                    url: nodeList[i].audioUrl,
                    acLedsGroupIndex: this.___acV_index,
                    viewAudioIndex: i
                }) ;
            }
            return viewAudios ;
        },
    /* ------------------- Setup ------------------- */
        ___acVsetPitch: function (referencePitch,pitch) {
            this.___acV_pitch = pitch ; 
            this.___acV_referencePitch = referencePitch ; 
        },
        ___acVinitAcLeds: function(){
            this.___acV_instruments = [] ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVinit();
            }
        },
        ___acVgetViewAudioCount: function(){
            return Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO').length;
        },
        ___acVsetTheme: function(e){
            this.customStyle =  e ;
            this.updateStyles();
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVsetTheme(this.customStyle);
            }
        },
        ___acVgetDefaultAudioUrls: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            var defaultAudioUrls = [];
            for (var i = 0; i < nodeList.length; i++) {
                if (nodeList[i].defaultAudioUrl !== null && nodeList[i].defaultAudioUrl !== undefined)
                    defaultAudioUrls.push(nodeList[i].defaultAudioUrl);
                }
            return defaultAudioUrls;
        },
        ___acVsetIndex: function (index) {
            this.___acV_index = index;
        },
        ___acVaddOrigin: async function(origin){
            this[origin+'AcLedActions'] = new LinkedList() ;
            if (origin !== 'playback') {
                this.___acV_instruments.push(origin) ;
            }
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].___acVaddOrigin(origin);
            }
            var nodeList2 = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            for (var j = 0; j < nodeList2.length; j++) {
                nodeList2[j].addOrigin(origin) ;
            }
        },
        ready: function () {
            this.___acV_MIDIEventToNoteMap = [] ;
            this.___acV_flags = []  ;
            this.___acV_instruments = [] ;
            this.___acV_mapKeyboardToNote = [] ;

            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLed]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setAttribute("channel"+nodeList[i].channel, "");
            }
            nodeList = Polymer.dom(this.root).querySelectorAll('VIEW-AUDIO');
            this.___acV_totalViewAudios = nodeList.length ;
            for (var i = 0; i < nodeList.length; i++) {
                var channel = nodeList[i].channel ;
                this.___acV_flags[channel] = false ;
                this.___acV_MIDIEventToNoteMap[channel] =  [] ;
                nodeList[i].setAttribute("channel"+channel, "");
                var acLeds = Polymer.dom(this.root).querySelectorAll('[channel'+channel+'][acLed]');
                for (var j = 0; j < acLeds.length; j++) {
                    var acId = acLeds[j].acId ; 
                    acLeds[j].setAttribute("id"+acId, "");
                    this.___acV_MIDIEventToNoteMap[channel][acId] = acId ;
                }
            }
            this.___acV_loadedViewAudios = 0;
            setInterval(this.___acV_updateGUI.bind(this), 5);
        }
    };
</script>
