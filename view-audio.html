<link rel="import" href="../polymer/polymer.html">

<dom-module id="view-audio">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "view-audio",
            observers: [],
            behaviors: [],
            listeners: {},
            properties: {
            /* ------------------- Loading ------------------- */
                defaultAudioUrl:{
                    type:String
                },
                audioUrl: {
                    type: String
                },
            /* ------------------- Initialization ------------------- */
                channel:{
                    type:Number
                },
                notesBuffers:{
                    type:Array,
                    value:[]
                },
                loopDurations:{
                    type:Array,
                    value:[]
                },
            /* ------------------- Volume ------------------- */
                instrumentVelocity:{
                    type:Number,
                    value:1
                },
                instrumentGain:{
                    type:Number,
                    value:1
                },
                playbackGain:{
                    type:Number,
                    value:1
                },
                instrumentPanner:{
                    type:Object
                },
                playbackPanner:{
                    type:Object
                },
                instrumentSynthGain:{
                    type:Object
                },
                playbackSynthGain:{
                    type:Object
                },
                playbackPanning:{
                    type:Number,
                    value:0
                },
                instrumentPanning:{
                    type:Number,
                    value:0
                },
            /* ------------------- Action ------------------- */
                // playbackButtonActions
                playbackActions:{
                    type:Array,
                    value:[]
                },
                // instrumentButtonActions
                activePlayback:{
                    type:Array,
                    value:[]
                },
                activeInstrument:{
                    type:Array,
                    value:[]
                },
                origins:{
                    type:Array,
                    value:[]
                }
            },
        /* --------- audio loading ----------------- */
            loadAudio: async function(audioUrl){
                this.audioUrl = audioUrl ;
                this.loopDurations = [] ;
                this.notesBuffers = [] ;
                this.playbackActions = [] ;
                for(let i = 0 ; i < this.origins.length ; i ++ ){
                    this[this.origins[i]+'Actions'] = []  ;  
                }
                var arrayBuffer = await(await fetch(audioUrl)).arrayBuffer();
                var bb = new DataView(arrayBuffer);
                var notesLoaded = 0, totalNotes = bb.getUint32(0);
                var currentByte = 4 ;
                for (var i = 0; i < totalNotes; i++) {
                    var loopDuration = bb.getFloat64(currentByte);
                    currentByte += 8 ;
                    var midiNote = bb.getUint32(currentByte) ;
                    currentByte += 4 ;
                    var byteLength = bb.getUint32(currentByte) ;
                    currentByte += 4 ;

                    var dstU8 = new Uint8Array(byteLength);
                    var srcU8 = new Uint8Array(arrayBuffer, currentByte, byteLength);
                    currentByte += byteLength ;
                    dstU8.set(srcU8);
                    var sound = dstU8;
                    var audioBuffer = await playbackContext.decodeAudioData(sound.buffer);
                    this.notesBuffers[midiNote] = audioBuffer ;
                    this.loopDurations[midiNote] = loopDuration ;
                    if (++notesLoaded === totalNotes)
                        this.fire('view-audio-load') ;
                }
            },
        /* ------------- Audio synth ------------------ */
            setVelocity: function(velocity){
                this.instrumentVelocity = velocity ;
                this.instrumentSynthGain.gain.value = this.instrumentGain*this.instrumentVelocity ;
            },
            _startAudio: function(note,e){
                if(e.origin ==='playback') {
                    var when = playbackContext.currentTime ;
                    if( (e.tempo)*(e.time-e.playbackTime)> 0)
                        when += (e.tempo)*(e.time-e.playbackTime)  ;
                    if(this.playbackActions[e.midiNote] === undefined || this.playbackActions[e.midiNote] === null)
                        this.playbackActions[e.midiNote] = {} ;
                    this.playbackActions[e.midiNote].gain = playbackContext.createGain();
                    this.playbackActions[e.midiNote].gain.value = 0.7 ;
                    this.playbackActions[e.midiNote].source = playbackContext.createBufferSource();
                    this.playbackActions[e.midiNote].source.buffer = this.notesBuffers[note] ;

                    if (this.loopDurations[note] !== -1) {
                        this.playbackActions[e.midiNote].source.loopStart = this.playbackActions[e.midiNote].source.buffer.duration - this.loopDurations[note];
                        this.playbackActions[e.midiNote].source.loopEnd = this.playbackActions[e.midiNote].source.buffer.duration;
                        this.playbackActions[e.midiNote].source.loop = true;
                    }

                    this.playbackActions[e.midiNote].source.connect(this.playbackActions[e.midiNote].gain);
                    this.playbackActions[e.midiNote].source.start(when);
                    this.playbackActions[e.midiNote].gain.connect(this.playbackSynthGain) ;
                }
                else{
                    if(this[e.origin+'Actions'][e.midiNote] === undefined || this[e.origin+'Actions'][e.midiNote] === null)
                        this[e.origin+'Actions'][e.midiNote] = {} ;
                    this[e.origin+'Actions'][e.midiNote].gain = instrumentContext.createGain();
                    this[e.origin+'Actions'][e.midiNote].gain.value = 0.7 ;
                    this[e.origin+'Actions'][e.midiNote].source = instrumentContext.createBufferSource();
                    this[e.origin+'Actions'][e.midiNote].source.buffer = this.notesBuffers[note] ;
                    
                    if (this.loopDurations[note] !== -1) {
                        this[e.origin+'Actions'][e.midiNote].source.loopStart = this[e.origin+'Actions'][e.midiNote].source.buffer.duration - this.loopDurations[note];
                        this[e.origin+'Actions'][e.midiNote].source.loopEnd = this[e.origin+'Actions'][e.midiNote].source.buffer.duration;
                        this[e.origin+'Actions'][e.midiNote].source.loop = true;
                    }

                    this[e.origin+'Actions'][e.midiNote].source.connect(this[e.origin+'Actions'][e.midiNote].gain);
                    this[e.origin+'Actions'][e.midiNote].source.start(instrumentContext.currentTime);
                    this[e.origin+'Actions'][e.midiNote].gain.connect(this.instrumentSynthGain) ;
                }
            },
            _stopAudio: function(e){
                var when =  playbackContext.currentTime ;
                if((e.tempo)*(e.time-e.playbackTime) > 0)
                    when += (e.tempo)*(e.time-e.playbackTime) ;
                if(e.origin==='playback' && this.playbackActions[e.midiNote] !== undefined && this.playbackActions[e.midiNote] !== null){
                    if (this.playbackActions[e.midiNote].gain !== undefined) {
                        this.playbackActions[e.midiNote].gain.gain.cancelScheduledValues(when) ;
                        this.playbackActions[e.midiNote].gain.gain.setValueAtTime(this.playbackActions[e.midiNote].gain.gain.value, when);
                        this.playbackActions[e.midiNote].gain.gain.exponentialRampToValueAtTime(0.00001, when+0.1);
                        this.playbackActions[e.midiNote].source.stop(when+0.1) ;
                        this.playbackActions[e.midiNote] = null ;
                    }
                }
                else if (this[e.origin+'Actions'][e.midiNote] !== undefined && this[e.origin+'Actions'][e.midiNote] !== null){
                    this[e.origin+'Actions'][e.midiNote].gain.gain.cancelScheduledValues(instrumentContext.currentTime) ;
                    this[e.origin+'Actions'][e.midiNote].gain.gain.setValueAtTime(this[e.origin+'Actions'][e.midiNote].gain.gain.value, instrumentContext.currentTime);
                    this[e.origin+'Actions'][e.midiNote].gain.gain.exponentialRampToValueAtTime(0.00001, instrumentContext.currentTime+0.1);
                    this[e.origin+'Actions'][e.midiNote].source.stop(instrumentContext.currentTime+0.1) ;
                    this[e.origin+'Actions'][e.midiNote] = null  ;
                }
            },
            initPlaybackAudio: function(){
                this.playbackSynthGain = playbackContext.createGain() ;
                this.playbackPanner = playbackContext.createStereoPanner() ;
                this.playbackSynthGain.connect(this.playbackPanner);
                this.playbackPanner.connect(playbackCompressor);
                this._updatePlaybackVolume() ;
                this._updatePlaybackPanning() ;
            },
        /* ------------------- Instrument ------------------- */
            initInstrumentVolume: function(){
                this.instrumentSynthGain = instrumentContext.createGain() ;
                this.instrumentPanner = instrumentContext.createStereoPanner() ;
                this.instrumentSynthGain.gain.value = this.instrumentGain ;
                this.instrumentPanner.pan.value = this.instrumentPanning ;
                this.instrumentSynthGain.connect(this.instrumentPanner);
                this.instrumentPanner.connect(instrumentCompressor);
            },
        /* ---------- Settings controls ------------ */
            setPlaybackGain: function(gain){
                this.playbackGain = gain ;
                this._updatePlaybackVolume() ;
            },
            setInstrumentGain: function(gain){
                this.instrumentGain = gain ;
                this._updateInstrumentVolume() ;
            },
            setPlaybackPanning: function(value){
                this.playbackPanning = value ;
                this._updatePlaybackPanning() ;
            },
            setInstrumentPanning: function(value){
                this.instrumentPanning = value ;
                this._updateInstrumentPanning() ;
            },
            _updatePlaybackPanning: function(){
                this.playbackPanner.pan.value = this.playbackPanning ;
            },
            _updateInstrumentPanning: function(){
                this.instrumentPanner.pan.value = this.instrumentPanning ;
            },
            _updateInstrumentVolume: async function(){
                await sleep(1000);
                if(this.instrumentSynthGain === undefined)
                    this.instrumentSynthGain = instrumentContext.createGain() ;
                if(this.instrumentPanner === undefined)
                    this.instrumentPanner = instrumentContext.createStereoPanner() ;
                if(this.instrumentGain !==undefined) {
                    this.instrumentSynthGain.gain.value = this.instrumentGain ;
                }
                this.instrumentSynthGain.connect(this.instrumentPanner);
                this.instrumentPanner.connect(instrumentCompressor);
            },
            _updatePlaybackVolume: function(){
                if(!this.playbackSynthGain)
                    this.playbackSynthGain = playbackContext.createGain() ;
                if(!this.playbackPanner)
                    this.playbackPanner = playbackContext.createStereoPanner() ;
                if(this.playbackGain !==undefined) {
                    this.playbackSynthGain.gain.value = this.playbackGain;
                }
                this.playbackSynthGain.connect(this.playbackPanner);
                this.playbackPanner.connect(playbackCompressor);
            },
        /* ------------------- Setup ------------------- */
            addOrigin: async function(origin){
                await this.originsSetupPromise ; 
                this.origins.push(origin) ; 
                this[origin+'Actions'] = [] ;
            },
            created: function () {
                this.originsSetupPromise = new Promise(resolve => this.originsSetupPromiseR = resolve);
            },
            ready: function () {
                this.loopDurations = [] ;
                this.notesBuffers = [] ;
                this.playbackActions = [] ;
                this.origins = [] ; 
                this.originsSetupPromiseR() ; 
                if(this.instrumentSynthGain === undefined)
                    this.instrumentSynthGain = instrumentContext.createGain() ;
                if(this.playbackSynthGain === undefined )
                    this.playbackSynthGain = playbackContext.createGain() ;
                if(this.instrumentPanner === undefined)
                    this.instrumentPanner = instrumentContext.createStereoPanner() ;
                if(this.playbackPanner === undefined ) {
                    this.playbackPanner = playbackContext.createStereoPanner() ;
                }
            }
        });
    </script>
</dom-module>
