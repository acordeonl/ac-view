<link rel="import" href="/bower_components/polymer/polymer.html">
<script>
/**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    acLedBehavior= {
        properties:{
            ___acV_prototype:{
                type:Object
            },
            ___acV_root:{
                type:Object
            },
            channel:{
                type:Number
            },
            acId:{
                type:Number
            },
            ___acV_customText:{
                type:Number,
                value:-1
            },
            ___acV_instruments:{
                type:Array
            },
            ___acV_showingPlaybackNotes:{
                type:Boolean,
                value:false
            },
            ___acV_showingInstrumentNotes:{
                type:Boolean,
                value:false
            }
        },
    /* ------------------- Helpers ------------------- */
        // Default colors for acLed
        ___acV_getAcLedColor: function(acLedState){
            if (acLedState === 1) {
                return '--theme-color1' ;
            }
            if (acLedState === 2) {
                return '--theme-color2' ;
            }
        },
        ___acV_getNoteName: function(note){
            var notes = [
                'C',
                'C#',
                'D',
                'Eb',
                'E',
                'F',
                'F#',
                'G',
                'Ab',
                'A',
                'Bb',
                'B'
            ];
            var octave = Math.floor(note / 12);
            var name = notes[note % 12];
            name += octave;
            return name;
        },
    /* ------------------- GUI ------------------- */
        ___acVtoggleNotes: async function(origin,value){
            await this.initAcLed ;
            if (origin === 'playback') {
                if(!value)
                    this.$$('[playbackNote]').style.visibility = 'hidden' ;
                else
                    this.$$('[playbackNote]').style.visibility = 'visible' ;
                this.___acV_showingPlaybackNotes = value ;
            }
            else {
                for (var i = 0; i < this.___acV_instruments.length; i++) {
                    var origin = this.___acV_instruments[i] ;
                    if(!value)
                        this.$$('['+origin+'Note]').style.visibility = 'hidden' ;
                    else
                        this.$$('['+origin+'Note]').style.visibility = 'visible' ;
                }
                this.___acV_showingInstrumentNotes = value ;
            }
        },
        ___acVsetOpacity: async function(origin,opacity){
            await this.initAcLed ;
            if (origin === 'playback') {
                this.$$('[playbackAcLed]').style.opacity = opacity ;
            }
            else {
                for (var i = 0; i < this.___acV_instruments.length; i++) {
                    var origin = this.___acV_instruments[i] ;
                    this.$$('['+origin+'AcLed]').style.opacity = opacity ;
                }
            }
        },
        ___acVrender: function(origin,acLedState,note){
            if (acLedState !== 0) {
                this.$$('['+origin+'AcLed]').style.display = 'block' ;
                var color = this.___acV_getAcLedColor(acLedState) ;
                if( color.startsWith('--') )
                    color = this.customStyle[color] ;
                this.$$('['+origin+'AcLed]').style.backgroundColor = color ;
                if (origin === 'playback') {
                    if(this['___acV_showingPlaybackNotes']){
                        this.$$('[playbackNote]').innerHTML = this.___acV_getNoteName(note) ;
                    }
                }
                else {
                    for (var i = 0; i < this.___acV_instruments.length; i++) {
                        var origin = this.___acV_instruments[i] ;
                        if(this['___acV_showingInstrumentNotes']){
                            this.$$('['+origin+'Note]').innerHTML = this.___acV_getNoteName(note) ;
                        }
                    }
                }
            }
            else {
                this.$$('['+origin+'AcLed]').style.display = 'none' ;
            }
        },
        ___acVclearGUI: async function(origin){
            await this.initAcLed ;
            if (this.$$('['+origin+'AcLed]') !== undefined && this.$$('['+origin+'AcLed]') !== null ) {
                this.$$('['+origin+'AcLed]').style.display = 'none' ;
            }
        },
    /* ------------------- Setup ------------------- */
        ___acVsetTheme: function(e){
            this.customStyle = e ;
            this.updateStyles() ;
            if (this.___acV_customText === 0 ) {
                var nodeList = Polymer.dom(this.root).querySelectorAll('[note]');
                for (i = 0; i < nodeList.length; i++) {
                    nodeList[i].style.color = this.customStyle['--content-background'] ;
                }
            }
        },
        ___acVaddOrigin: function(origin){
            console.log('adding origin',origin); 
            var newOrigin  = this.___acV_prototype.cloneNode(true);
            newOrigin.setAttribute(origin+'AcLed',"") ;
            this.___acV_root.appendChild (newOrigin) ;

            this.$$('['+origin+'AcLed] [note]').setAttribute(origin+'Note',"") ;
            this.$$('['+origin+'AcLed]').style.display = 'none';

            if(origin === 'playback')
                this.$$('['+origin+'AcLed]').style.opacity = this.playbackOpacity;
            else {
                this.___acV_instruments.push(origin) ;
                this.$$('['+origin+'AcLed]').style.opacity = this.instrumentOpacity;
            }
        },
        ___acVinit: function(){
            this.___acV_instruments = [] ;
            var acLed = this.$$('[acLed]') ;
            if(acLed.getAttribute('dev') !== null && acLed.getAttribute('dev') !== undefined)
                return ;

            acLed.style.position = 'absolute' ;
            this.___acV_prototype = acLed.cloneNode(true)  ;
            if ( this.$$('[acLed] [note]') === null || this.$$('[acLed] [note]') === undefined ) {
                this.___acV_customText = 0 ;
                var noteElement = document.createElement('div') ;
                noteElement.setAttribute('note',"") ;
                noteElement.style.width = '100%';
                noteElement.style.height = '100%';
                noteElement.style.position = 'absolute' ;
                noteElement.style.color = this.customStyle['--content-background'];
                noteElement.style.fontWeight = '400' ;
                noteElement.style.fontSize = '18px';
                noteElement.style.display = 'flex';
                noteElement.style.justifyContent = 'center';
                noteElement.style.alignItems = 'center';
                acLed.appendChild(noteElement) ;
                this.___acV_prototype = acLed.cloneNode(true)  ;
            }
            else{
                this.___acV_customText = 1 ;
            }

            this.___acV_root = acLed.parentNode ;
            this.___acV_root.removeChild(acLed) ;


            this.initAcLedR() ;
        },
        ready: function () {
            this.___acV_instruments = [] ;
            this.initAcLed = new Promise(resolve => this.initAcLedR = resolve);
        }
    } ;
</script>
