<link rel="import" href="/bower_components/polymer/polymer.html">
<script>
    var playbackContext,
        playbackConvolver,
        playbackDry,
        playbackWet,
        playbackCompressor,
        playbackMasterGain;

    var instrumentContext,
        instrumentConvolver,
        instrumentDry,
        instrumentWet,
        instrumentCompressor,
        instrumentMasterGain;

    var convolverBuffer = null ;
    var sleep = n => new Promise (resolve => setTimeout(resolve,n)) ;
    async function initAudioContext(origin) {
        window[origin+'Context'] = null;
        window[origin+'Convolver'] = null;
        window[origin+'Dry'] = null;
        window[origin+'Wet'] = null;
        window[origin+'Compressor'] = null;
        window[origin+'MasterGain'] = null;
        window[origin+'Context'] = new AudioContext();
        window[origin+'Convolver'] = window[origin+'Context'].createConvolver();
        if(convolverBuffer === null){
            var convolverArrayBuffer = await(await fetch("/data/16_IR_Pool_Size_00.wav")).arrayBuffer();
            convolverBuffer = await window[origin+'Context'].decodeAudioData(convolverArrayBuffer) ;
        }
        window[origin+'Convolver'].buffer = convolverBuffer;
        window[origin+'Dry'] = window[origin+'Context'].createGain();
        window[origin+'Wet'] = window[origin+'Context'].createGain();
        window[origin+'MasterGain'] = window[origin+'Context'].createGain();
        window[origin+'Compressor'] = window[origin+'Context'].createDynamicsCompressor();
        window[origin+'Compressor'].threshold.value = 0;
        window[origin+'Compressor'].knee.value = 0;
        window[origin+'Compressor'].ratio.value = 20;
        window[origin+'Compressor'].attack.value = 0.005;
        window[origin+'Compressor'].release.value = 0.05;
        window[origin+'Compressor'].threshold.value = 0;
        window[origin+'Compressor'].connect(window[origin+'Convolver']);
        window[origin+'Compressor'].connect(window[origin+'Dry']);
        window[origin+'Convolver'].connect(window[origin+'Wet']);
        window[origin+'Dry'].connect(window[origin+'MasterGain']);
        window[origin+'Wet'].connect(window[origin+'MasterGain']);
        window[origin+'MasterGain'].connect(window[origin+'Context'].destination);
        if (origin === 'playback') {
            playbackAudioContextInitR() ;
        }
        else {
            instrumentAudioContextInitR() ;
        }
    }

    var playbackAudioContextInit = new Promise(resolve => playbackAudioContextInitR = resolve);
    var instrumentAudioContextInit = new Promise(resolve => instrumentAudioContextInitR = resolve);
    initAudioContext('instrument');
    initAudioContext('playback');
    function stopAudio () {
        return  new Promise( resolve => {
            playbackMasterGain.gain.cancelScheduledValues(playbackContext.currentTime);
            playbackMasterGain.gain.setValueAtTime(playbackMasterGain.gain.value, playbackContext.currentTime);
            playbackMasterGain.gain.exponentialRampToValueAtTime(0.00001, playbackContext.currentTime + 0.1);
            setTimeout( () => { resolve() }, 100);
        });
    }
    /**
* Behavior that highlights stuff.
*
* @polymerBehavior
*/
    ACViewBehavior = {
        listeners: {
            'action': 'onMidiEvent',
            'acLedGroup-loaded': '_onAcLedGroupLoaded'
        },
        properties: {
            playingChords:{
                type:Boolean,
                value:false
            },
            hasChord:{
                type:Boolean,
                value:false
            },
            pitch: {
                type: Number,
                value: -1
            },
            referencePitch:{
                type:Number
            },
            recording: {
                type: Object
            },
            currentPlaybackTime: {
                type: Object
            },
            defaultReverb: {
                type: Number,
                value: 0
            },
            reverb: {
                type: Number,
                value: 0
            },
            totalAcLedGroups: {
                type: Number,
                value: 0
            },
            loadedAcLedGroups: {
                type: Number,
                value: 0
            },
            finishedLoading: {
                type: Boolean,
                value: false
            },
            rotation: {
                type: Boolean,
                value: false
            },
            recording: {
                type: Boolean,
                value: false
            }
        },
    /* ------------------- acView Communication ------------------- */
        _acViewCallFunction: function (functionName, args) {
            if (parent !== window) {
                parent.postMessage([
                    functionName, args
                ], '*');
            } else {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.fire('ac-view-call', {
                        functionName: functionName,
                        args: args
                    });
                });
            }
        },
    /* ------------- Loading --------------------- */
        _setReferencePitch: function (pitch) {
            this.pitch = pitch;
            this.referencePitch = pitch ;
            this.setReferencePitchPromiseR();
        },
        _onAcLedGroupLoaded: function () {
            this.loadedAcLedGroups++;
            if (this.loadedAcLedGroups === this.totalAcLedGroups) {
                this._acViewCallFunction('onACViewAudioLoad', {});
                this.finishedLoading = true;
                this._onFinishedLoadingNotes();
            }
        },
        getAcLedGroups: function () {
            var acLedGroups = [] ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++)
                acLedGroups.push (nodeList[i].getAcLedGroup() ) ;
            this._acViewCallFunction('getAcLedGroupsResponse', acLedGroups);
        },
        getViewAudios: function () {
            var viewAudios = [] ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (let i = 0; i < nodeList.length; i++) {
                var tmp = nodeList[i].getViewAudios()  ;
                for (let j = 0; j < tmp.length; j++) {
                    viewAudios.push(tmp[j]) ;
                }
            }
            this._acViewCallFunction('getViewAudiosResponse', viewAudios);
        },
        getDefaultAudioUrls: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            var defaultAudioUrls = [];
            for (var i = 0; i < nodeList.length; i++) {
                var res = nodeList[i].getDefaultAudioUrls();
                if (res.length > 0)
                    defaultAudioUrls.push(res);
                }
            this._acViewCallFunction('getDefaultAudioUrlsResponse', defaultAudioUrls);
        },
        loadAudio: function (audioUrls) {
            this.loadedAcLedGroups = 0;
            this.finishedLoading = false;
            if (this.viewAudioCount === undefined) {
                this.viewAudioCount = []  ;
                var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
                for (var i = 0; i < nodeList.length; i++) {
                    nodeList[i].setIndex(i);
                    this.viewAudioCount[i] = nodeList[i].getViewAudioCount () ;
                }
            }

            var ledGroup = 0 , cnt = 0 ;  ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < audioUrls.length; i++) {
                if (i-cnt === this.viewAudioCount[ledGroup]) {
                    cnt += this.viewAudioCount[ledGroup] ;
                    ledGroup++ ;
                }
                if (nodeList[ledGroup] !== undefined)
                    nodeList[ledGroup].loadAudio(i-cnt, audioUrls[i]);
            }
        },
    /* ------------- MIDI --------------------- */
        onMIDIEvent: function (e) {
            if (!this.finishedLoading)
                return;
            if (e.cmd === 'velocity-change') {
                this._setVelocity(e.velocity);
            }
            this._onMIDIEvent(e);
        },
        _setVelocity: function (velocity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setVelocity(velocity / 127);
            }
        },
    /* ------------- playback controls -------------- */
        stop: async function () {
            this.clearActions('playback') ;
            await stopAudio() ;
            playbackContext.close();
            playbackAudioContextInit = new Promise(resolve => playbackAudioContextInitR = resolve);
            initAudioContext('playback');
            await playbackAudioContextInit ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++)
                nodeList[i].initPlaybackAudio();
            this.setReverb(this.reverb);
            this._acViewCallFunction('onACViewReadyToPlay', {});
        },
        clearGUI: function (origin) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].clearGUI(origin);
            }
        },
        clearActions: function(origin){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].clearActions(origin);
            }
        },
    /* ------------------- Chords ------------------- */
        setCurrentChord: function (arg) {
            this.currentChord = arg ;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            var midiNote = this.midiNameToNumber[arg.substr(0,arg.indexOf(' '))] ;
            var description = arg.substr(arg.indexOf(' ')+1);
            var diff = this.pitch-this.referencePitch ;
            this.hasChord = false ;
            for (var i = 0; i < nodeList.length; i++) {
                this.hasChord |= nodeList[i].setCurrentChord(midiNote-diff,description);
            }
            if (!this.hasChord && this.playingChords) {
                this._acViewCallFunction('toast','El acorde seleccionado no está disponible en la visualización') ;

            }
        },
        restartChord: function(){
            if (this.currentChord !== undefined) {
                this.setCurrentChord(this.currentChord) ;
            }
        },
        toggleChords: function(playingChords){
            this.playingChords = playingChords ;
            if (!this.hasChord && this.playingChords) {
                this._acViewCallFunction('toast','El acorde seleccionado no está disponible en la visualización') ;
            }
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleChords(playingChords) ;
            }
        },
    /* ------------- settings controls -------------- */
        settingsUpdate: function (origin, value) {
            if (value === null || value === undefined || isNaN(value))
                return;
            var arr = origin.split('_');
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            if (arr.length === 3) {
                if (arr[0] === 'playback') {
                    if (arr[1] === 'volume')
                        nodeList[arr[2]].playbackVolume = value / 100;
                    if (arr[1] === 'panning') {
                        nodeList[arr[2]].playbackPanning = value / 100;
                    }
                }
                if (arr[0] === 'instrument') {
                    if (arr[1] === 'volume')
                        nodeList[arr[2]].instrumentVolume = value / 100;
                    if (arr[1] == 'panning')
                        nodeList[arr[2]].instrumentPanning = value / 100;
                    }
                } else if (arr.length === 2) {
                if (arr[1] === 'opacity')
                    this.setOpacity(arr[0], value);
                }
            else {
                if (arr[0] === 'reverbSlider') {
                    this.setReverb(value);
                }
            }
        },
        toggleNotes: function (e) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].toggleNotes(e.origin, e.value);
            }
        },
        setOpacity: function (origin, opacity) {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setOpacity(origin, opacity / 100);
            }
        },
        setReverb: function (value) {
            synthReverb = value;
            playbackWet.gain.value = (1.0 - ((100 - synthReverb) / 100));
            playbackDry.gain.value = (100 - synthReverb) / 100;
            instrumentWet.gain.value = (1.0 - ((100 - synthReverb) / 100));
            instrumentDry.gain.value = (100 - synthReverb) / 100;
        },
        setRotation: function (rotation) {
            this.rotation = rotation;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].rotation = rotation;
            }
        },
    /* ------------------- Recording Data ------------------- */
        _requestRecording: function () {
            this._acViewCallFunction('setRecording', {});
        },
        setRecording: function (recording) {
            this.recording = recording;
        },
        _requestCurrentPlaybackTime: function () {
            this._acViewCallFunction('setCurrentPlaybackTime', {});
        },
        setCurrentPlaybackTime: function (time) {
            this.currentPlaybackTime = time;
        },
    /* --------------- Setup ------------------- */
        _initAcLeds: function () {
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].initAcLeds();
            }
        },
        setPitch: async function(pitch){
            await this.setReferencePitchPromise ;
            var diff = pitch - this.pitch;
            this.pitch += diff;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            var supported = true ;
            for (var i = 0; i < nodeList.length; i++)
                supported &= nodeList[i].addPitch(diff);
            this._acViewCallFunction('onACViewPitchUpdate') ;
            if (!supported) {
                this._acViewCallFunction('toast','Algunas notas no podrán ser reproducidas debido a que no se encuentran en el audio de la visualización') ;
            }
        },
        setTheme: function (e) {
            this.customStyle = e;
            this.updateStyles();
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].setTheme(this.customStyle);
            }
        },
        setPreferences: async function (e) {
            await playbackAudioContextInit ;
            await instrumentAudioContextInit ;
            this.setReverb(e['reverb']);
            this.reverb = e['reverb'];
            this.setRotation(e['rotation']);
            this.settingsUpdate('playback_opacity', e['playback_opacity']);
            this.settingsUpdate('instrument_opacity', e['instrument_opacity']);
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                this.settingsUpdate('playback_volume_' + i, e['playback_volume_' + i]);
                this.settingsUpdate('playback_panning_' + i, e['playback_panning_' + i]);
                this.settingsUpdate('instrument_volume_' + i, e['instrument_volume_' + i]);
                this.settingsUpdate('instrument_panning_' + i, e['instrument_panning_' + i]);
            }
            this.toggleNotes({origin: "playback", value: e['showingPlaybackNotes']});
            this.toggleNotes({origin: "instrument", value: e['showingInstrumentNotes']});
        },
        _setDefaultReverb: function (reverb) {
            this.defaultReverb = reverb ;
            this._acViewCallFunction('setReverb', this.defaultReverb);
        },
        addOrigin: function(origin){
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList[i].addOrigin(origin);
            }
        },
        ready: function () {
            this.setReferencePitchPromise = new Promise(resolve => this.setReferencePitchPromiseR = resolve);
            this.loadedAcLedGroups = 0;
            var nodeList = Polymer.dom(this.root).querySelectorAll('[acLedGroup]');
            this.totalAcLedGroups = nodeList.length;
            this.chords = [] ;
            this.midiNameToNumber = [] ;
            for (let i = 0; i < nodeList.length; i++) {
                var chrs = nodeList[i].chords ;
                if (chrs!==undefined) {
                    for (let j = 0; j < chrs.length; j++) {
                        if (chrs[j]===undefined)
                        continue ;
                        for (var key in chrs[j]) {
                            var noteName = "C C#D EbE F F#G AbA BbB ";
                            noteName = (noteName.substring((j % 12) * 2, (j % 12) * 2 + 2) + (Math.floor(j / 12) ).toString()).replace(" ", "");
                            this.midiNameToNumber[noteName] = j ;
                            var chord = noteName+' '+key;
                            var add = true ;
                            for (let k = 0; k < this.chords.length; k++) {
                                if (this.chords[k] === chord)
                                add = false ;
                            }
                            if (add)
                            this.chords.push(chord) ;
                        }
                    }
                }
            }
            this.chords.sort() ;
            this._acViewCallFunction('setChords', this.chords);
            this._initAcLeds();
            this.addOrigin('chord') ;
            this.addOrigin('instrument') ;
            this.addOrigin('playback') ;
            //if in an iframe
            if (window !== parent) {
                window.onmessage = args => {
                    this[args.data[0]](args.data[1]);
                } ;
            }
        }
    };
</script>
